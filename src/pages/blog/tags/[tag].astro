---
import Layout from '@layouts/Layout.astro';
import FormattedDate from '@components/FormattedDate.astro';
import Tags from '@components/Tags.astro';
import { getCollection } from 'astro:content';
import { Picture } from 'astro:assets';

export async function getStaticPaths() {
  const posts = await getCollection('blog');

  // Get all unique tags from all posts
  const allTags = new Set<string>();
  posts.forEach((post) => {
    post.data.tags?.forEach((tag) => allTags.add(tag));
  });

  // Return one path for each tag
  return Array.from(allTags).map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

interface Props {
  tag: string;
}

const { tag } = Astro.props;

// Get all posts that contain this tag
const allPosts = await getCollection('blog');
const postsWithTag = allPosts
  .filter((post) => post.data.tags?.includes(tag))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<style>
  .title {
    margin: 0;
    color: rgb(var(--black));
    line-height: 1;
  }

  ul {
    display: flex;
    flex-wrap: wrap;
    max-width: 800px;
    justify-content: center;
    gap: 2rem;
    list-style-type: none;
    margin: 0;
    padding: 0;
    margin-left: auto;
    margin-right: auto;
  }

  ul li {
    width: calc(50% - 1rem);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  ul li * {
    transition: 0.2s ease;
  }

  ul li:first-child {
    width: 100%;
    margin-bottom: 1rem;
    align-items: center;
  }

  ul a:hover img {
    box-shadow: var(--box-shadow);
  }

  @media (width <= 720px) {
    ul {
      gap: 0.5em;
    }

    ul li {
      width: 100%;
      text-align: center;
    }

    ul li:first-child {
      margin-bottom: 0;
    }

    ul li:first-child .title {
      font-size: 1.563em;
    }
  }
</style>

<Layout title={`Posts tagged with "${tag}"`}>
  <main class="main-width flex flex-col py-12">
    <div class="mb-8">
      <h1 class="my-0">Posts tagged with "{tag}"</h1>
      <p class="text-gray-400">
        Found {postsWithTag.length} post{postsWithTag.length !== 1 ? 's' : ''} with this tag.
        <a href="/blog" class="text-[var(--accent-main)] hover:text-[var(--accent-light)]">
          ‚Üê Back to all posts
        </a>
      </p>
    </div>

    {
      postsWithTag.length === 0 ? (
        <div class="text-center text-gray-400">
          <p>No posts found with the tag "{tag}".</p>
        </div>
      ) : (
        <ul>
          {postsWithTag.map((post) => (
            <li>
              <a href={`/${post.id}/`} aria-label={`Read more about ${post.data.title}`}>
                <Picture
                  src={post.data.heroImage ?? '../assets/images/placeholder.png'}
                  alt={post.data.heroImageAlt}
                  formats={['avif', 'webp']}
                  fallbackFormat="webp"
                  class="rounded-xl"
                  loading={postsWithTag[0]?.id === post.id ? 'eager' : 'lazy'}
                />
              </a>
              <a href={`/${post.id}/`}>
                <h3 class="title">{post.data.title}</h3>
              </a>
              <p class="date text-sm">
                <FormattedDate date={post.data.pubDate} />
                {post.data.updatedDate && (
                  <>
                    | Updated <FormattedDate date={post.data.updatedDate} />
                  </>
                )}
              </p>
              <p class="introduction text-base">{post.data.description}</p>
              <Tags tags={post.data.tags} />
            </li>
          ))}
        </ul>
      )
    }
  </main>
</Layout>
